import tkinter as tk
from tkinter import filedialog
import cv2
import numpy as np
import tensorflow as tf
from tensorflow.keras.models import load_model
import mediapipe as mp
import os

# ØªØ¹Ø·ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ TensorFlow Ø§Ù„ØªØ­Ø°ÙŠØ±ÙŠØ©
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'

# **Ø­Ø¯Ø¯ Ù…Ø³Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù‡Ù†Ø§**
MODEL_PATH = r'C:\Users\DELL\Desktop\project8-hand-recognetion\hand_gesture_model.h5'  # Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
if not os.path.exists(MODEL_PATH):
    raise FileNotFoundError(f"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯: {MODEL_PATH}")

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø¯Ø±Ø¨
model = load_model(MODEL_PATH)

# Ø§Ù„Ø¥ÙŠÙ…Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
gestures = ["Hello", "Good", "Bad"]

# Mediapipe Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙŠØ¯
mp_hands = mp.solutions.hands
hands = mp_hands.Hands(static_image_mode=True, max_num_hands=1, min_detection_confidence=0.5)

def extract_hand_landmarks(image_path):
    """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø§Ù„Ù… Ø§Ù„ÙŠØ¯ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©"""
    image = cv2.imread(image_path)
    if image is None:
        return None, "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±."

    image_rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
    results = hands.process(image_rgb)

    if not results.multi_hand_landmarks:
        return None, "Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙŠØ¯ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©."

    hand_landmarks = results.multi_hand_landmarks[0]
    landmarks = []
    for landmark in hand_landmarks.landmark:
        landmarks.extend([landmark.x, landmark.y, landmark.z])

    if len(landmarks) != 63:
        return None, "Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØµØ­ÙŠØ­Ø© (63 Ù†Ù‚Ø·Ø©)."

    return np.array(landmarks, dtype=np.float32), None

def predict_gesture(image_path):
    """Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø§Ù„Ø¥ÙŠÙ…Ø§Ø¡Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©"""
    landmarks, error = extract_hand_landmarks(image_path)
    if error:
        return error

    # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ÙƒÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„ØªÙ†Ø§Ø³Ø¨ Ø´ÙƒÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (1, 21, 3)
    landmarks = landmarks.reshape(1, 21, 3)

    # Ø§Ù„ØªÙ†Ø¨Ø¤
    prediction = model.predict(landmarks)
    predicted_index = np.argmax(prediction)
    predicted_label = gestures[predicted_index]
    confidence = prediction[0][predicted_index] * 100
    return f"Ø§Ù„ØªÙ†Ø¨Ø¤: {predicted_label} (Ø§Ù„Ø¯Ù‚Ø©: {confidence:.2f}%)"

def load_and_predict():
    """ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ†Ø¨Ø¤"""
    file_path = filedialog.askopenfilename(filetypes=[("Image Files", "*.jpg *.jpeg *.png")])
    if not file_path:
        return

    # Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
    img = cv2.imread(file_path)
    if img is not None:
        img_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
        img_resized = cv2.resize(img_rgb, (400, 400))
        img_tk = tk.PhotoImage(data=cv2.imencode('.png', img_resized)[1].tobytes())
        image_label.config(image=img_tk)
        image_label.image = img_tk

    # ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ†Ø¨Ø¤
    result = predict_gesture(file_path)
    result_label.config(text=result)
    upload_new_button.pack(pady=10)  # Ø¹Ø±Ø¶ Ø²Ø± Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¨Ø¤

def reset_interface():
    """Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©"""
    image_label.config(image="")
    image_label.image = None
    result_label.config(text="")
    upload_new_button.pack_forget()  # Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰

# Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Tkinter
window = tk.Tk()
window.title("Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ÙŠØ¯")

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø®Ø·ÙˆØ·
window.configure(bg="#f0f8ff")
font_title = ("Arial", 18, "bold")
font_text = ("Arial", 14)

# Ù†Øµ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
title_label = tk.Label(window, text="ğŸ“¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ÙŠØ¯ ğŸ¤š", font=font_title, bg="#f0f8ff", fg="#333")
title_label.pack(pady=20)

# ØªØ¹Ù„ÙŠÙ…Ø§Øª
instruction_label = tk.Label(window, text="Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ù„Ø¥Ø´Ø§Ø±Ø© ÙŠØ¯ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.", font=font_text, bg="#f0f8ff", fg="#555")
instruction_label.pack(pady=10)

# Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
load_button = tk.Button(window, text="ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©", font=font_text, command=load_and_predict, bg="#4caf50", fg="white", padx=10, pady=5)
load_button.pack(pady=10)

# Ù…Ø³Ø§Ø­Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
image_label = tk.Label(window, bg="#f0f8ff")
image_label.pack()

# Ù…Ø³Ø§Ø­Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
result_label = tk.Label(window, text="", font=("Arial", 14), bg="#f0f8ff", fg="#000")
result_label.pack(pady=10)

# Ø²Ø± Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¨Ø¤)
upload_new_button = tk.Button(window, text="ğŸ“‚ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©", font=font_text, command=reset_interface, bg="#2196f3", fg="white", padx=10, pady=5)
upload_new_button.pack_forget()  # Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©

# ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
window.mainloop()
